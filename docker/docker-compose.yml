# version: '3.8'

# services:
#   postgres:
#     image: postgres:15-alpine
#     container_name: spectrum-postgres-prod
#     environment:
#       POSTGRES_USER: ${DB_USER}
#       POSTGRES_PASSWORD: ${DB_PASSWORD}
#       POSTGRES_DB: ${DB_NAME}
#     volumes:
#       - postgres_data_prod:/var/lib/postgresql/data
#       - /etc/localtime:/etc/localtime:ro  # Синхронизация времени
#     restart: unless-stopped
#     networks:
#       - spectrum-prod-network
#     # В продакшене НЕ открываем порты наружу!
#     # ports: отключены для безопасности
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#     # Ограничения ресурсов
#     deploy:
#       resources:
#         limits:
#           memory: 512M
#         reservations:
#           memory: 256M

#   bot:
#     # В продакшене используем уже собранный образ
#     image: spectrum-club-bot:${IMAGE_TAG:-latest}
#     container_name: spectrum-bot-prod
#     environment:
#       APP_ENV: production
#       BOT_TOKEN: ${BOT_TOKEN}
#       BOT_DEBUG: ${BOT_DEBUG:-false}
#       DB_HOST: postgres
#       DB_PORT: 5432
#       DB_USER: ${DB_USER}
#       DB_PASSWORD: ${DB_PASSWORD}
#       DB_NAME: ${DB_NAME}
#       DB_SSL_MODE: ${DB_SSL_MODE:-require}
#       LOG_LEVEL: ${LOG_LEVEL:-info}
#       # Для мониторинга и алертов
#       ADMIN_IDS: ${ADMIN_IDS:-}
#     restart: unless-stopped
#     networks:
#       - default
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
#     # Мониторинг (опционально)
#     labels:
#       - "prometheus.scrape=true"
#       - "prometheus.port=8080"
#       - "prometheus.path=/metrics"
#     # Ограничения ресурсов
#     deploy:
#       resources:
#         limits:
#           memory: 256M
#           cpus: '0.5'
#         reservations:
#           memory: 128M
#           cpus: '0.1'

# networks:
#   spectrum-prod-network:
#     driver: bridge
#     # Более безопасная сеть
#     ipam:
#       config:
#         - subnet: 172.20.0.0/16

# volumes:
#   postgres_data_prod:
#     name: spectrum_postgres_data_prod
#     # Можно добавить драйвер для бэкапов
#     # driver: local
#     # driver_opts:
#     #   type: nfs
#     #   o: addr=192.168.1.100,rw
#     #   device: ":/path/to/nfs/share"


version: '3.8'

services:
  bot:
    image: spectrum-club-bot:${IMAGE_TAG:-latest}
    container_name: spectrum-bot-prod
    environment:
      APP_ENV: production
      BOT_TOKEN: ${BOT_TOKEN}
      DB_HOST: postgres-db-spectrum  # Указываем имя существующего контейнера
      DB_PORT: 5432
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_SSL_MODE: ${DB_SSL_MODE:-require}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    restart: unless-stopped
    # Подключаемся к той же сети, что и postgres-db-spectrum
    network_mode: bridge  # Если postgres-db-spectrum в сети bridge
    # ИЛИ
    networks:
      - existing-network  # Если знаешь имя сети

# Если используешь конкретную сеть
networks:
  existing-network:
    external: true
    name: bridge  # или другое имя сети