<div class="container">
  <!-- Header -->
  <div class="calendar-header">
    <div class="header-left">
      <a [routerLink]="['/calendar']" [queryParams]="{user_id: route.snapshot.queryParams['user_id']}" class="logo">
        Spectrum<span>Club</span>
      </a>
      <div class="current-date">{{ getMonthYear() }}</div>
    </div>
    <div class="header-right">
      <div class="view-selector">
        <button 
          class="view-btn active" 
          (click)="changeView('month')">
          –ú–µ—Å—è—Ü
        </button>
      </div>
      <button 
        *ngIf="calendarData?.user_id" 
        class="g-btn"
        (click)="changeView('schedule')">
        –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      </button>
    </div>
  </div>

  <!-- Navigation -->
  <div class="calendar-nav">
    <button class="g-btn" (click)="navigateDate('prev')">‚Äπ</button>
    <span class="nav-date">{{ getDateRange() }}</span>
    <button class="g-btn" (click)="navigateDate('next')">‚Ä∫</button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <!-- Error -->
  <div *ngIf="error" class="error">{{ error }}</div>

  <!-- Main Calendar Content -->
  <div *ngIf="calendarData && !loading">
    <!-- Month View -->
    <div *ngIf="currentView === 'month' && calendarData.calendar_days" class="calendar-grid">
      <!-- Day headers -->
      <div *ngFor="let day of calendarData.week_days" class="day-header">
        <div class="day-name">{{ day.name }}</div>
        <div class="date-num">{{ day.day }}</div>
      </div>

      <!-- Calendar cells -->
      <div 
        *ngFor="let day of calendarData.calendar_days"
        class="calendar-cell"
        [class.today]="day.is_today"
        [class.other-month]="day.is_other_month"
        [attr.data-date]="day.date">
        <div class="day-number" [class.today-indicator]="day.is_today">{{ getDayFromDate(day.date) }}</div>
        
        <div class="events-container">
          <div 
            *ngFor="let event of day.events; trackBy: trackByEventId; let i = index"
            class="calendar-event month-event"
            [ngClass]="getEventColorClass(event.color_index)"
            (click)="showEventDetails(event.id)"
            [title]="event.title + ' - ' + event.time">
            <div class="event-title">{{ event.title }}</div>
            <div class="event-time">{{ event.time }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule View (list) -->
    <div *ngIf="currentView === 'schedule' && calendarData.training_days" style="margin: 24px;">
      <div *ngFor="let scheduleDay of calendarData.training_days" class="schedule-day">
        <h3 class="day-title">{{ scheduleDay.date }}</h3>
        
        <div 
          *ngFor="let training of scheduleDay.trainings"
          class="schedule-event"
          [ngClass]="getEventColorClass(training.color_index)"
          (click)="showEventDetails(training.id)">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="event-time-display">
              {{ training.start_time }} ‚Äì {{ training.end_time }}
            </div>
            <div class="event-details">
              <div class="event-main-title">{{ training.group_name }}</div>
              <div class="event-meta">
                <span *ngIf="training.coach_name">üë®‚Äçüè´ {{ training.coach_name }}</span>
                <span *ngIf="training.participants > 0"> ‚Ä¢ üë• {{ training.participants }} –∑–∞–ø–∏—Å–∞–ª–∏—Å—å</span>
              </div>
            </div>
            <div *ngIf="!calendarData.is_coach">
              <button 
                *ngIf="training.can_register"
                class="g-btn g-btn-primary" 
                style="padding: 6px 12px;"
                (click)="showEventDetails(training.id); $event.stopPropagation()">
                –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
              </button>
              <div *ngIf="training.is_registered" style="display: flex; gap: 8px; align-items: center;">
                <span style="color: #137333; font-size: 13px; padding: 6px 12px; background: #e6f4ea; border-radius: 4px;">
                  ‚úÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã
                </span>
                <button 
                  class="g-btn g-btn-danger-outline" 
                  style="padding: 6px 12px;"
                  (click)="showEventDetails(training.id); $event.stopPropagation()">
                  –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
              </div>
              <span 
                *ngIf="training.is_full && !training.is_registered"
                style="color: #d93025; font-size: 13px; padding: 6px 12px; background: #fce8e6; border-radius: 4px;">
                ‚ö†Ô∏è –ú–µ—Å—Ç –Ω–µ—Ç
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Training Details -->
  <div *ngIf="showModal" class="modal" (click)="closeModal()">
    <div class="modal-overlay" (click)="closeModal()"></div>
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle">
          <span *ngIf="loadingTraining">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          <span *ngIf="!loadingTraining && selectedTraining">{{ selectedTraining.training.group_name }}</span>
        </h3>
        <button class="modal-close" (click)="closeModal()">√ó</button>
      </div>
      <div class="modal-body" *ngIf="selectedTraining && !loadingTraining">
        <div class="training-details">
          <div class="detail-row">
            <span class="detail-label">üìÖ –î–∞—Ç–∞:</span>
            <span class="detail-value">{{ formatDate(selectedTraining.training.training_date) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">‚è∞ –í—Ä–µ–º—è:</span>
            <span class="detail-value">{{ selectedTraining.training.start_time }} - {{ selectedTraining.training.end_time }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">üë®‚Äçüè´ –¢—Ä–µ–Ω–µ—Ä:</span>
            <span class="detail-value">{{ selectedTraining.training.coach_name || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">üèÉ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</span>
            <span class="detail-value">
              {{ selectedTraining.participants_count }}
              <span *ngIf="selectedTraining.training.max_participants">
                / {{ selectedTraining.training.max_participants }}
              </span>
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ:</span>
            <span class="detail-value">{{ selectedTraining.training.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}</span>
          </div>
          
          <div *ngIf="selectedTraining.participants && selectedTraining.participants.length > 0" 
               id="modalAttendanceSection" style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px; color: #3c4043;">–ó–∞–ø–∏—Å–∞–≤—à–∏–µ—Å—è:</h4>
            <div class="attendance-list">
              <div *ngFor="let participant of selectedTraining.participants" class="attendance-item">
                <div class="attendance-avatar">
                  {{ participant.student_name ? participant.student_name.charAt(0).toUpperCase() : '?' }}
                </div>
                <div>
                  <div class="attendance-name">{{ participant.student_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' }}</div>
                  <div class="attendance-time">–ó–∞–ø–∏—Å–∞–Ω: {{ formatDateTime(participant.created_at) }}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-actions" style="margin-top: 20px;">
            <button 
              *ngIf="selectedTraining.is_registered"
              class="modal-btn modal-btn-secondary" 
              (click)="closeModal()">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
            <button 
              *ngIf="selectedTraining.is_registered"
              class="modal-btn modal-btn-danger" 
              (click)="cancelRegistration()">
              –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
            <button 
              *ngIf="selectedTraining.can_register"
              class="modal-btn modal-btn-secondary" 
              (click)="closeModal()">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
            <button 
              *ngIf="selectedTraining.can_register"
              class="modal-btn modal-btn-primary" 
              (click)="registerForTraining()">
              –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
            </button>
            <div *ngIf="!selectedTraining.can_register && !selectedTraining.is_registered">
              <button class="modal-btn modal-btn-secondary" (click)="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
              <span style="color: #5f6368; padding: 10px;">
                –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
                <span *ngIf="selectedTraining.is_full"> (–ú–µ—Å—Ç –Ω–µ—Ç)</span>
                <span *ngIf="selectedTraining.is_past"> (–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ—à–ª–∞)</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
