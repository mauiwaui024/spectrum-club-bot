# name: üöÄ Deploy to Production

# on:
#   push:
#     branches: [ main, master ]
#     paths:
#       - '**.go'
#       - 'go.mod'
#       - 'go.sum'
#       - 'Dockerfile'
#       - 'docker-compose.yml'
#       - 'scripts/**'
#       - '.github/workflows/**'
#   workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     environment: production  # –ò—Å–ø–æ–ª—å–∑—É–µ–º environment –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤
    
#     steps:
#     - name: üì• Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: üîê Setup SSH
#       uses: webfactory/ssh-agent@v0.9.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: üåê Add server to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

#     - name: üèóÔ∏è Build Docker image
#       run: |
#         docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
#         docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

#     - name: üì¶ Copy files to server
#       run: |
#         scp -r \
#           bot-image.tar.gz \
#           docker-compose.yml \
#           scripts/ \
#           ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/

#     - name: üöÄ Deploy on server
#       run: |
#         ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
#           cd /opt/spectrum-bot && \
          
#           # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑
#           docker load -i bot-image.tar.gz && \
          
          # # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          # cat > scripts/.env << EOF
          # BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          # DB_USER=${{ secrets.DB_USER }}
          # DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          # DB_NAME=${{ secrets.DB_NAME }}
          # DB_SSL_MODE=${{ secrets.DB_SSL_MODE }}
          # APP_ENV=production
          # LOG_LEVEL=${{ secrets.LOG_LEVEL }}
          # BOT_DEBUG=${{ secrets.BOT_DEBUG }}
          # ADMIN_IDS=${{ secrets.ADMIN_IDS }}
          # IMAGE_TAG=${{ github.sha }}
          # EOF
          
#           # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π
#           cd scripts && \
#           chmod +x deploy.sh && \
#           ./deploy.sh
#         "

#     - name: üìù Deployment status
#       run: |
#         echo "‚úÖ Deployment completed successfully!"
#         echo "Commit: ${{ github.sha }}"
#         echo "Branch: ${{ github.ref }}"
name: üöÄ Deploy to Production

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìÅ Verify files exist
      run: |
        if [ -f "./docker/Dockerfile" ]; then
          echo "‚úÖ Dockerfile found at ./docker/Dockerfile"
        else
          echo "‚ùå Dockerfile not found at ./docker/Dockerfile"
          exit 1
        fi
        
        if [ -f "docker/docker-compose.yml" ]; then
          echo "‚úÖ docker-compose.yml found"
        else
          echo "‚ùå docker-compose.yml not found"
          exit 1
        fi

    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: üèóÔ∏è Build Docker image
      run: |
        docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
        docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

    - name: üìù Create .env file locally
      run: |
        # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
        cat > .env << 'EOF'
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        DB_SSL_MODE=require
        LOG_LEVEL=info
        BOT_DEBUG=false
        APP_ENV=production
        IMAGE_TAG=${{ github.sha }}
        EOF
        
        echo "‚úÖ .env file created"
        echo "üìÑ .env content (keys only):"
        cat .env | sed 's/=.*/=[HIDDEN]/'

    - name: üì¶ Copy files to server
      run: |
        scp -o StrictHostKeyChecking=no \
            bot-image.tar.gz \
            docker/docker-compose.yml \
            .env \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/
        echo "‚úÖ Files copied successfully"

  - name: üöÄ Deploy on server
    run: |
      ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
        set -e
        
        echo 'üì¶ Loading Docker image...'
        cd /opt/spectrum-bot
        docker load -i bot-image.tar.gz
        
        echo 'üîç Getting PostgreSQL container IP...'
        # –ü–æ–ª—É—á–∞–µ–º IP –∞–¥—Ä–µ—Å PostgreSQL –≤ —Å–µ—Ç–∏ postgres-db_postgres-net
        POSTGRES_IP=\$(docker inspect -f '{{range .NetworkSettings.Networks}}{{if eq .NetworkName \"postgres-db_postgres-net\"}}{{.IPAddress}}{{end}}{{end}}' postgres-db-spectrum)
        echo \"PostgreSQL IP in network: \${POSTGRES_IP}\"
        
        if [ -z \"\${POSTGRES_IP}\" ]; then
          echo '‚ùå Cannot get PostgreSQL IP. Trying bridge network...'
          POSTGRES_IP=\$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' postgres-db-spectrum | head -1)
          echo \"PostgreSQL IP (bridge): \${POSTGRES_IP}\"
        fi
        
        if [ -z \"\${POSTGRES_IP}\" ]; then
          echo '‚ùå Cannot get PostgreSQL IP at all!'
          exit 1
        fi
        
        echo 'üìù Updating .env with PostgreSQL IP...'
        sed -i \"s|DB_HOST=.*|DB_HOST=\${POSTGRES_IP}|\" .env
        
        echo 'üîÑ Updating docker-compose.yml with new tag...'
        sed -i 's|image: spectrum-club-bot:.*|image: spectrum-club-bot:${{ github.sha }}|' docker-compose.yml
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π docker-compose –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Å–µ—Ç–∏
        cat > docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          bot:
            image: spectrum-club-bot:\${IMAGE_TAG:-latest}
            container_name: spectrum-bot-prod
            environment:
              APP_ENV: \${APP_ENV}
              BOT_TOKEN: \${BOT_TOKEN}
              DB_HOST: \${DB_HOST}
              DB_PORT: 5432
              DB_USER: \${DB_USER}
              DB_PASSWORD: \${DB_PASSWORD}
              DB_NAME: \${DB_NAME}
              DB_SSL_MODE: \${DB_SSL_MODE}
              LOG_LEVEL: \${LOG_LEVEL}
            restart: unless-stopped
        EOF
        
        echo 'üöÄ Starting bot...'
        docker compose down --remove-orphans 2>/dev/null || true
        docker compose --env-file .env up -d
        
        echo '‚è≥ Waiting for bot to start...'
        sleep 10
        
        echo 'üîç Bot logs:'
        docker compose logs --tail=20 bot
      "