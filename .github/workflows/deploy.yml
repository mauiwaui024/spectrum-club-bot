# name: ğŸš€ Deploy to Production

# on:
#   push:
#     branches: [ main, master ]
#     paths:
#       - '**.go'
#       - 'go.mod'
#       - 'go.sum'
#       - 'Dockerfile'
#       - 'docker-compose.yml'
#       - 'scripts/**'
#       - '.github/workflows/**'
#   workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     environment: production  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ environment Ğ´Ğ»Ñ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
    
#     steps:
#     - name: ğŸ“¥ Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: ğŸ” Setup SSH
#       uses: webfactory/ssh-agent@v0.9.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: ğŸŒ Add server to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

#     - name: ğŸ—ï¸ Build Docker image
#       run: |
#         docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
#         docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

#     - name: ğŸ“¦ Copy files to server
#       run: |
#         scp -r \
#           bot-image.tar.gz \
#           docker-compose.yml \
#           scripts/ \
#           ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/

#     - name: ğŸš€ Deploy on server
#       run: |
#         ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
#           cd /opt/spectrum-bot && \
          
#           # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ·
#           docker load -i bot-image.tar.gz && \
          
          # # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
          # cat > scripts/.env << EOF
          # BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          # DB_USER=${{ secrets.DB_USER }}
          # DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          # DB_NAME=${{ secrets.DB_NAME }}
          # DB_SSL_MODE=${{ secrets.DB_SSL_MODE }}
          # APP_ENV=production
          # LOG_LEVEL=${{ secrets.LOG_LEVEL }}
          # BOT_DEBUG=${{ secrets.BOT_DEBUG }}
          # ADMIN_IDS=${{ secrets.ADMIN_IDS }}
          # IMAGE_TAG=${{ github.sha }}
          # EOF
          
#           # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
#           cd scripts && \
#           chmod +x deploy.sh && \
#           ./deploy.sh
#         "

#     - name: ğŸ“ Deployment status
#       run: |
#         echo "âœ… Deployment completed successfully!"
#         echo "Commit: ${{ github.sha }}"
#         echo "Branch: ${{ github.ref }}"
name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ Verify files exist
      run: |
        if [ -f "./docker/Dockerfile" ]; then
          echo "âœ… Dockerfile found at ./docker/Dockerfile"
        else
          echo "âŒ Dockerfile not found at ./docker/Dockerfile"
          exit 1
        fi
        
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… docker-compose.yml found"
        else
          echo "âŒ docker-compose.yml not found"
          exit 1
        fi

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
        docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

    - name: ğŸ“ Create .env file locally
      run: |
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»
        cat > .env << 'EOF'
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        DB_SSL_MODE=require
        LOG_LEVEL=info
        BOT_DEBUG=false
        APP_ENV=production
        IMAGE_TAG=${{ github.sha }}
        EOF
        
        echo "âœ… .env file created"
        echo "ğŸ“„ .env content (keys only):"
        cat .env | sed 's/=.*/=[HIDDEN]/'

    - name: ğŸ“¦ Copy files to server
      run: |
        scp -o StrictHostKeyChecking=no \
            bot-image.tar.gz \
            docker-compose.yml \
            .env \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/
        echo "âœ… Files copied successfully"

    - name: ğŸš€ Deploy on server
      run: |
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          set -e
          
          echo 'ğŸ“¦ Loading Docker image...'
          cd /opt/spectrum-bot
          docker load -i bot-image.tar.gz
          
          echo 'ğŸ”„ Updating docker-compose.yml with new tag...'
          sed -i 's|image: spectrum-club-bot:.*|image: spectrum-club-bot:${{ github.sha }}|' docker-compose.yml
          
          echo 'ğŸš€ Starting services...'
          docker compose down --remove-orphans 2>/dev/null || true
          docker compose --env-file .env up -d
          
          echo 'â³ Waiting for services to start...'
          sleep 15
          
          echo 'ğŸ§¹ Cleaning up...'
          rm -f bot-image.tar.gz
          
          echo 'âœ… Deployment completed!'
          echo ''
          echo 'ğŸ“Š Container status:'
          docker ps --filter 'name=spectrum' --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'
          echo ''
          echo 'ğŸ” PostgreSQL logs:'
          docker compose logs --tail=10 postgres
        "