name: üöÄ Deploy to Production

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìÅ Verify files exist
      run: |
        if [ -f "./docker/Dockerfile" ]; then
          echo "‚úÖ Dockerfile found at ./docker/Dockerfile"
        else
          echo "‚ùå Dockerfile not found at ./docker/Dockerfile"
          exit 1
        fi
        
        if [ -f "docker/docker-compose.yml" ]; then
          echo "‚úÖ docker-compose.yml found"
        else
          echo "‚ùå docker-compose.yml not found"
          exit 1
        fi

    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: üèóÔ∏è Build Docker image
      run: |
        docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
        docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

    - name: üìù Create .env file locally
      run: |
        # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
        cat > .env << 'EOF'
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        DB_SSL_MODE=disable
        LOG_LEVEL=info
        BOT_DEBUG=false
        APP_ENV=production
        IMAGE_TAG=${{ github.sha }}
        EOF
        
        echo "‚úÖ .env file created"
        echo "üìÑ .env content (keys only):"
        cat .env | sed 's/=.*/=[HIDDEN]/'

    - name: üì¶ Copy files to server
      run: |
        scp -o StrictHostKeyChecking=no \
            bot-image.tar.gz \
            docker/docker-compose.yml \
            .env \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/
        # –ö–æ–ø–∏—Ä—É–µ–º –≤–µ–±-—à–∞–±–ª–æ–Ω—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
        # scp -r -o StrictHostKeyChecking=no \
        #     web/ \
        #     ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/
        echo "‚úÖ All files copied successfully"

    - name: üöÄ Deploy on server
      run: |
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          set -e
          
          echo 'üì¶ Loading Docker image...'
          cd /opt/spectrum-bot
          docker load -i bot-image.tar.gz
          
          echo 'üîç Getting PostgreSQL container IP...'
          # –ü–æ–ª—É—á–∞–µ–º IP –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ postgres-db-spectrum
          POSTGRES_IP=\$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' postgres-db-spectrum)
          echo \"PostgreSQL IP: \${POSTGRES_IP}\"
          
          echo 'üìù Updating .env with PostgreSQL IP...'
          # –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª —Å IP –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ —Ö–æ—Å—Ç–∞
          sed -i \"s|DB_HOST=.*|DB_HOST=\${POSTGRES_IP}|\" .env
          echo \"Updated DB_HOST to: \${POSTGRES_IP}\"
          
          echo 'üîÑ Updating docker-compose.yml with new tag...'
          sed -i 's|image: spectrum-club-bot:.*|image: spectrum-club-bot:${{ github.sha }}|' docker-compose.yml
          
          echo 'üöÄ Starting bot...'
          docker compose down --remove-orphans 2>/dev/null || true
          docker compose --env-file .env up -d
          
          echo '‚è≥ Waiting for bot to start...'
          sleep 10
          
          echo 'üîç Bot logs:'
          docker compose logs --tail=20 bot
        "