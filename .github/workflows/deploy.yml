# name: ðŸš€ Deploy to Production

# on:
#   push:
#     branches: [ main, master ]
#     paths:
#       - '**.go'
#       - 'go.mod'
#       - 'go.sum'
#       - 'Dockerfile'
#       - 'docker-compose.yml'
#       - 'scripts/**'
#       - '.github/workflows/**'
#   workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     environment: production  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ environment Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
    
#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: ðŸ” Setup SSH
#       uses: webfactory/ssh-agent@v0.9.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: ðŸŒ Add server to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

#     - name: ðŸ—ï¸ Build Docker image
#       run: |
#         docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
#         docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz

#     - name: ðŸ“¦ Copy files to server
#       run: |
#         scp -r \
#           bot-image.tar.gz \
#           docker-compose.yml \
#           scripts/ \
#           ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/

#     - name: ðŸš€ Deploy on server
#       run: |
#         ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
#           cd /opt/spectrum-bot && \
          
#           # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·
#           docker load -i bot-image.tar.gz && \
          
#           # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
#           cat > scripts/.env << EOF
#           BOT_TOKEN=${{ secrets.BOT_TOKEN }}
#           DB_USER=${{ secrets.DB_USER }}
#           DB_PASSWORD=${{ secrets.DB_PASSWORD }}
#           DB_NAME=${{ secrets.DB_NAME }}
#           DB_SSL_MODE=${{ secrets.DB_SSL_MODE }}
#           APP_ENV=production
#           LOG_LEVEL=${{ secrets.LOG_LEVEL }}
#           BOT_DEBUG=${{ secrets.BOT_DEBUG }}
#           ADMIN_IDS=${{ secrets.ADMIN_IDS }}
#           IMAGE_TAG=${{ github.sha }}
#           EOF
          
#           # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
#           cd scripts && \
#           chmod +x deploy.sh && \
#           ./deploy.sh
#         "

#     - name: ðŸ“ Deployment status
#       run: |
#         echo "âœ… Deployment completed successfully!"
#         echo "Commit: ${{ github.sha }}"
#         echo "Branch: ${{ github.ref }}"
name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“ Verify Dockerfile exists
      run: |
        if [ -f "./docker/Dockerfile" ]; then
          echo "âœ… Dockerfile found at ./docker/Dockerfile"
        else
          echo "âŒ Dockerfile not found at ./docker/Dockerfile"
          echo "Looking for Dockerfile..."
          find . -name "Dockerfile*" -type f
          exit 1
        fi

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ðŸ—ï¸ Build Docker image
      run: |
        echo "ðŸ”¨ Building Docker image..."
        docker build -t spectrum-club-bot:${{ github.sha }} -f ./docker/Dockerfile .
        
        echo "ðŸ·ï¸ Tagging as latest..."
        docker tag spectrum-club-bot:${{ github.sha }} spectrum-club-bot:latest
        
        echo "ðŸ’¾ Saving image to archive..."
        docker save spectrum-club-bot:${{ github.sha }} | gzip > bot-image.tar.gz
        
        echo "ðŸ“Š Image info:"
        docker images | grep spectrum-club-bot

    - name: ðŸ“¦ Copy files to server
      run: |
        echo "ðŸ“¤ Copying files to server..."
        scp -r \
          bot-image.tar.gz \
          docker-compose.yml \
          ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/opt/spectrum-bot/

    - name: ðŸš€ Deploy on server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          cd /opt/spectrum-bot && \
          
          echo 'ðŸ“¦ Loading Docker image...' && \
          docker load -i bot-image.tar.gz && \
          
          echo 'ðŸ”„ Updating docker-compose.yml with new tag...' && \
          sed -i 's/image: spectrum-club-bot:.*/image: spectrum-club-bot:${{ github.sha }}/' docker-compose.yml && \
          
          echo 'ðŸš€ Restarting services...' && \
          docker-compose down --remove-orphans 2>/dev/null || true && \
          docker-compose up -d && \
          
          echo 'ðŸ§¹ Cleaning up...' && \
          rm -f bot-image.tar.gz && \
          
          echo 'âœ… Deployment completed!' && \
          echo '' && \
          echo 'ðŸ“Š Container status:' && \
          docker ps --filter 'name=spectrum' --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'
        "